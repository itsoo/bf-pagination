package com.sncfc.baseframework.pageplugin;

import com.sncfc.baseframework.pageplugin.core.Dialect;
import com.sncfc.baseframework.pageplugin.util.ReflectHelpers;
import com.sncfc.baseframework.pageplugin.util.SqlGenerators;
import lombok.extern.slf4j.Slf4j;
import org.apache.ibatis.executor.statement.StatementHandler;
import org.apache.ibatis.mapping.BoundSql;
import org.apache.ibatis.mapping.MappedStatement;
import org.apache.ibatis.plugin.Interceptor;
import org.apache.ibatis.plugin.Intercepts;
import org.apache.ibatis.plugin.Invocation;
import org.apache.ibatis.plugin.Signature;
import org.apache.ibatis.reflection.SystemMetaObject;
import org.springframework.stereotype.Component;

import javax.xml.bind.PropertyException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.Properties;

import static com.sncfc.baseframework.pageplugin.PageInfo.defaultPageSize;

/**
 * 分页插件
 *
 * @author zxy
 */
@Slf4j
@Component
@Intercepts(@Signature(type = StatementHandler.class, method = "prepare", args = {Connection.class, Integer.class}))
public class PagePlugin implements Interceptor {

    /*** 数据库方言 */
    private static Dialect dialect;
    /*** 需要拦截的 Mapper */
    private static String regexp;

    @Override
    public Object intercept(Invocation inv) throws Throwable {
        if (inv.getTarget() instanceof StatementHandler) {
            final StatementHandler handler = (StatementHandler) inv.getTarget();
            if (getMappedStatement(handler).getId().matches(regexp)) {
                final BoundSql boundSql = getBoundSql(handler);
                final Object params = boundSql.getParameterObject();
                if (PageInfo.instance(params).isPageList()) {
                    final String countSql = SqlGenerators.generateCountSql(boundSql.getSql());
                    final int count = queryTotalCount(handler, countSql, (Connection) inv.getArgs()[0], params);
                    final PageInfo pageInfo = handlePageInfo(params, count);
                    final PageInfo condition = count <= pageInfo.getPageSize() ? null : pageInfo;
                    final String pageSql = SqlGenerators.generatePageSql(dialect, boundSql.getSql(), condition);
                    ReflectHelpers.setFieldValue(boundSql, "sql", pageSql);
                }
            }
        }

        return inv.proceed();
    }

    @Override
    public void setProperties(Properties properties) {
        dialect = Dialect.getEnum(properties.getProperty("dialect"));
        if (dialect == null) {
            log.error("必要的属性为空", new PropertyException("dialect 属性用于指定数据库方言"));
        }

        regexp = properties.getProperty("regexp");
        if (regexp == null || "".equals(regexp.trim())) {
            log.error("必要的属性为空", new PropertyException("regexp 属性用于指定 SQL 拦截表达式"));
        }

        final String pageSize = properties.getProperty("page-size");
        if (pageSize != null && !"".equals(pageSize.trim())) {
            defaultPageSize = Integer.parseInt(pageSize);
        }
    }

    private int queryTotalCount(StatementHandler handler, String sql, Connection connection, Object obj)
            throws Throwable {
        final BoundSql boundSql = getBoundSql(handler);
        final BoundSql countBoundSql =
                new BoundSql(getMappedStatement(handler).getConfiguration(), sql, boundSql.getParameterMappings(), obj);
        ReflectHelpers.copyObjectField(boundSql, countBoundSql, "metaParameters");
        ReflectHelpers.copyObjectField(boundSql, countBoundSql, "additionalParameters");

        try (PreparedStatement countStatement = connection.prepareStatement(sql)) {
            handler.getParameterHandler().setParameters(countStatement);
            try (ResultSet rs = countStatement.executeQuery()) {
                return rs.next() ? rs.getInt(1) : 0;
            }
        }
    }

    private PageInfo handlePageInfo(Object params, int count) {
        if (params instanceof PageInfo) {
            return ((PageInfo) params).setTotalCount(count).instance();
        }

        return PageInfo.instance(params).setTotalCount(count).instance();
    }

    private MappedStatement getMappedStatement(StatementHandler handler) {
        return (MappedStatement) SystemMetaObject.forObject(handler).getValue("delegate.mappedStatement");
    }

    private BoundSql getBoundSql(StatementHandler handler) {
        return (BoundSql) SystemMetaObject.forObject(handler).getValue("delegate.boundSql");
    }
}
