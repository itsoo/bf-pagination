package com.sncfc.baseframework.pageplugin.util;

import com.sncfc.baseframework.pageplugin.PageInfo;
import com.sncfc.baseframework.pageplugin.core.Dialect;

import javax.xml.bind.PropertyException;

/**
 * SqlGenerators
 *
 * @author zxy
 */
public class SqlGenerators {

    /**
     * 组织查询总记录数 SQL
     *
     * @param sql String
     * @return count sql
     */
    public static String generateCountSql(String sql) {
        return String.format("SELECT count(*) FROM (%s) \"$tmp_0\"", sql);
    }

    /**
     * 根据数据库方言组织分页 SQL
     *
     * @param dialect  Dialect
     * @param sql      String
     * @param pageInfo PageInfo
     * @return page sql
     * @throws PropertyException PropertyException
     */
    public static String generatePageSql(Dialect dialect, String sql, PageInfo pageInfo) throws PropertyException {
        if (pageInfo != null) {
            switch (dialect) {
                case MYSQL:
                    return mysql(sql, pageInfo);
                case ORACLE:
                    return oracle(sql, pageInfo);
                default:
                    throw new PropertyException("未被分页组件支持的数据库: " + dialect);
            }
        }

        return sql;
    }

    private static String mysql(String sql, PageInfo pageInfo) {
        return String.format("SELECT * FROM (%s) LIMIT %d, %d",
                sql, pageInfo.getStartRows(), pageInfo.getPageSize());
    }

    private static String oracle(String sql, PageInfo pageInfo) {
        return String.format("SELECT * FROM (SELECT \"$tmp_0\".*, rownum \"$rn_0\" FROM (%s) \"$tmp_0\") WHERE \"$rn_0\" > %d AND \"$rn_0\" <= %d",
                sql, pageInfo.getStartRows(), pageInfo.getEndRows());
    }
}
